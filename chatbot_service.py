import re
import json
import random
from datetime import datetime
import pandas as pd
import numpy as np

class PropTechChatbot:
    def __init__(self, ml_service):
        self.ml_service = ml_service
        self.conversation_history = []
        self.user_context = {}
        self.session_data = {}
        self.load_responses()
        self.load_knowledge_base()
    
    def load_responses(self):
        """Load predefined responses and patterns"""
        self.patterns = {
            'greeting': [
                r'hi|hello|hey|good morning|good afternoon|good evening|namaste',
                [
                    "Hello! I'm your PropTech investment assistant. How can I help you with Mumbai real estate today?",
                    "Hi there! Ready to explore Mumbai's real estate opportunities? What would you like to know?",
                    "Welcome to PropTech ML! I can help you with ROI calculations, market analysis, and investment advice. What interests you?",
                    "Namaste! I'm here to help you make smart real estate investments in Mumbai. What can I assist you with?"
                ]
            ],
            'roi_query': [
                r'roi|return on investment|calculate roi|what.*roi|roi.*(\d+).*lakh|(\d+).*lakh.*roi|returns|profit',
                [
                    "I can help you calculate ROI! Please provide the locality and property price. For example: 'Calculate ROI for ‚Çπ50L property in Andheri'",
                    "Let me calculate the ROI for you. Which locality and what property price are you considering?",
                    "ROI calculation is my specialty! Just tell me the area and budget, and I'll give you detailed analysis."
                ]
            ],
            'locality_info': [
                r'tell me about|information about|details about|what about|how is|locality|area|neighborhood',
                [
                    "I can provide detailed information about any Mumbai locality. Which area interests you?",
                    "I have comprehensive data on Mumbai localities. Which area would you like to explore?",
                    "I know Mumbai real estate inside out! Which locality would you like to learn about?"
                ]
            ],
            'investment_advice': [
                r'investment advice|recommend|suggest|best area|where to invest|crore budget|lakh budget|portfolio|strategy',
                [
                    "I'd be happy to provide investment advice! What's your budget and investment goals?",
                    "Let me help you find the best investment opportunities. What's your budget range?",
                    "Investment strategy is crucial! Tell me your budget and I'll create a personalized plan."
                ]
            ],
            'price_comparison': [
                r'compare|comparison|vs|versus|difference between|which is better|better option',
                [
                    "I can compare different localities for you. Which areas would you like me to compare?",
                    "Great! I'll help you compare localities. Please specify which areas you're interested in.",
                    "Comparison analysis coming up! Which two or more areas should I analyze?"
                ]
            ],
            'market_trends': [
                r'trends|market|growth|future|prediction|forecast|outlook|analysis',
                [
                    "Based on our data analysis, I can share market trends and predictions. What specific trend interests you?",
                    "I have insights on Mumbai real estate trends. Are you interested in price trends, ROI trends, or rental trends?",
                    "Market analysis is my forte! What aspect of Mumbai real estate trends would you like to explore?"
                ]
            ],
            'emi_calculator': [
                r'emi|loan|calculate emi|monthly payment|installment|mortgage|home loan',
                [
                    "I can calculate EMI for you! Please provide loan amount, interest rate, and tenure. Example: 'EMI for ‚Çπ50L at 8.5% for 20 years'",
                    "Let me help with EMI calculation. What's the loan amount, interest rate, and tenure?",
                    "EMI calculations made easy! Just give me the loan details and I'll do the math."
                ]
            ],
            'risk_assessment': [
                r'risk|risky|safe|safety|secure|investment risk|market risk',
                [
                    "I can assess investment risks for you. Which locality or investment are you concerned about?",
                    "Risk analysis is important! Tell me about your investment and I'll evaluate the risks.",
                    "Let me help you understand the risks. What specific investment are you considering?"
                ]
            ],
            'rental_yield': [
                r'rental yield|rent|rental income|tenant|renting|lease',
                [
                    "I can help you understand rental yields! Which area are you looking at for rental income?",
                    "Rental yield analysis coming up! Tell me the locality and I'll show you the potential.",
                    "Rental income is a great strategy! Which area interests you for rental properties?"
                ]
            ],
            'help': [
                r'help|what can you do|features|capabilities|commands|options|menu',
                ["""ü§ñ **PropTech AI Assistant - Complete Feature Guide**

**üè† CORE REAL ESTATE FUNCTIONS:**
‚Ä¢ **ROI Calculator** - "Calculate ROI for ‚Çπ50L in Andheri"
‚Ä¢ **Investment Advisor** - "Investment advice for ‚Çπ1 crore budget"
‚Ä¢ **Market Comparison** - "Compare Bandra vs Powai"
‚Ä¢ **Locality Analysis** - "Tell me about Thane real estate"
‚Ä¢ **Price Predictions** - "Future prices in Goregaon"

**üí∞ FINANCIAL CALCULATIONS:**
‚Ä¢ **EMI Calculator** - "EMI for ‚Çπ80L at 8.5% for 20 years"
‚Ä¢ **Affordability Check** - "What can I afford with ‚Çπ20L down payment"
‚Ä¢ **Rental Yield** - "Rental income potential in Malad"
‚Ä¢ **Risk Assessment** - "Investment risks in Lower Parel"

**üìä MARKET INTELLIGENCE:**
‚Ä¢ **Heat Map Insights** - "Explain ROI hotspots in Mumbai"
‚Ä¢ **Trend Analysis** - "Mumbai real estate trends 2024"
‚Ä¢ **Growth Areas** - "Which areas are growing fastest"
‚Ä¢ **Infrastructure Impact** - "Metro effect on property prices"

**üéØ PERSONALIZED ADVICE:**
‚Ä¢ **Portfolio Planning** - "Diversify ‚Çπ2 crore across Mumbai"
‚Ä¢ **First-time Buyer** - "Best areas for first property"
‚Ä¢ **Investor Strategy** - "Rental vs appreciation focus"
‚Ä¢ **Exit Strategy** - "When to sell property in Bandra"

**üí° SMART FEATURES:**
‚Ä¢ **Quick Calculations** - Instant ROI, EMI, affordability
‚Ä¢ **Area Recommendations** - Based on your budget & goals
‚Ä¢ **Market Alerts** - Hot deals and opportunities
‚Ä¢ **Investment Timeline** - When to buy/sell/hold

Just ask me anything about Mumbai real estate! I'm here 24/7 to help! üöÄ"""]
            ],
            'thanks': [
                r'thank you|thanks|appreciate|helpful|great|awesome|excellent',
                [
                    "You're welcome! I'm here whenever you need real estate advice. Feel free to ask more questions!",
                    "Happy to help! Is there anything else about Mumbai real estate you'd like to know?",
                    "Glad I could assist! Don't hesitate to reach out for more investment insights.",
                    "My pleasure! I'm always here to help with your real estate journey."
                ]
            ],
            'goodbye': [
                r'bye|goodbye|see you|exit|quit|end',
                [
                    "Goodbye! Best of luck with your real estate investments. Come back anytime for more advice!",
                    "See you later! Remember, I'm here 24/7 for all your Mumbai real estate questions.",
                    "Take care! May your investments bring great returns. Feel free to chat again soon!",
                    "Bye! Happy investing, and remember - location, location, location! üè†"
                ]
            ]
        }
    
    def load_knowledge_base(self):
        """Load real estate knowledge base"""
        self.knowledge_base = {
            'mumbai_areas': {
                'premium': ['bandra', 'juhu', 'worli', 'lower parel', 'marine drive', 'colaba'],
                'emerging': ['thane', 'kalyan', 'vasai', 'virar', 'dombivli', 'badlapur'],
                'established': ['andheri', 'goregaon', 'malad', 'kandivali', 'borivali', 'powai'],
                'commercial': ['bkc', 'nariman point', 'fort', 'churchgate', 'andheri east']
            },
            'investment_tips': {
                'first_time': "Start with established suburbs, focus on connectivity, check legal documents",
                'experienced': "Diversify across micro-markets, consider commercial properties, time the market",
                'rental_focus': "Choose areas with IT hubs, good transport, young demographics",
                'appreciation_focus': "Look for infrastructure development, upcoming projects, land scarcity"
            },
            'market_insights': {
                'growth_drivers': ['metro expansion', 'it sector growth', 'infrastructure development', 'government policies'],
                'risk_factors': ['regulatory changes', 'interest rate fluctuations', 'oversupply', 'economic slowdown']
            }
        }
    
    def process_message(self, user_message):
        """Process user message and generate response"""
        try:
            original_message = user_message
            user_message = user_message.lower().strip()
            
            # Store conversation
            self.conversation_history.append({
                "user": original_message, 
                "timestamp": datetime.now(),
                "processed": user_message
            })
            
            # Extract entities
            entities = self.extract_entities(user_message)
            
            # Update user context
            self.update_user_context(user_message, entities)
            
            # Generate response
            response = self.generate_response(user_message, entities)
            
            # Store bot response
            self.conversation_history.append({
                "bot": response, 
                "timestamp": datetime.now(),
                "entities": entities
            })
            
            return response
            
        except Exception as e:
            return "Sorry, I encountered an error processing your message. Please try rephrasing your question or ask for help to see what I can do!"
    
    def extract_entities(self, message):
        """Extract entities like localities, prices, percentages from message"""
        entities = {
            'localities': [],
            'prices': [],
            'percentages': [],
            'numbers': [],
            'intent': None,
            'budget_range': None,
            'timeframe': None
        }
        
        try:
            # Extract localities
            localities = self.ml_service.data.get('localities', [])
            for locality in localities:
                if locality.lower() in message:
                    entities['localities'].append(locality)
            
            # Extract prices with various formats
            price_patterns = [
                r'‚Çπ(\d+(?:\.\d+)?)\s*cr|‚Çπ(\d+(?:\.\d+)?)\s*crore',  # Crores
                r'‚Çπ(\d+(?:\.\d+)?)\s*l|‚Çπ(\d+(?:\.\d+)?)\s*lakh',    # Lakhs
                r'(\d+(?:\.\d+)?)\s*crore',                          # Crores without ‚Çπ
                r'(\d+(?:\.\d+)?)\s*lakh',                           # Lakhs without ‚Çπ
                r'‚Çπ(\d+(?:\.\d+)?)\s*k|‚Çπ(\d+(?:\.\d+)?)\s*thousand' # Thousands
            ]
            
            for pattern in price_patterns:
                matches = re.findall(pattern, message, re.IGNORECASE)
                for match in matches:
                    if isinstance(match, tuple):
                        for m in match:
                            if m:
                                value = float(m)
                                if 'crore' in pattern:
                                    entities['prices'].append(value * 100)  # Convert to lakhs
                                elif 'thousand' in pattern or 'k' in pattern:
                                    entities['prices'].append(value / 100)  # Convert to lakhs
                                else:
                                    entities['prices'].append(value)
                    else:
                        entities['prices'].append(float(match))
            
            # Extract percentages
            percentage_matches = re.findall(r'(\d+(?:\.\d+)?)\s*%', message)
            entities['percentages'] = [float(p) for p in percentage_matches]
            
            # Extract general numbers
            number_matches = re.findall(r'\b(\d+(?:\.\d+)?)\b', message)
            entities['numbers'] = [float(n) for n in number_matches]
            
            # Determine budget range
            if entities['prices']:
                max_price = max(entities['prices'])
                if max_price >= 100:
                    entities['budget_range'] = 'high'  # 1 crore+
                elif max_price >= 50:
                    entities['budget_range'] = 'medium'  # 50L - 1Cr
                else:
                    entities['budget_range'] = 'low'  # Under 50L
            
            # Extract timeframe
            timeframe_patterns = [
                r'(\d+)\s*year', r'(\d+)\s*month', r'short term', r'long term',
                r'immediate', r'urgent', r'soon', r'future'
            ]
            for pattern in timeframe_patterns:
                if re.search(pattern, message, re.IGNORECASE):
                    entities['timeframe'] = re.search(pattern, message, re.IGNORECASE).group()
                    break
            
        except Exception as e:
            pass
        
        return entities
    
    def update_user_context(self, message, entities):
        """Update user context for personalized responses"""
        if entities['budget_range']:
            self.user_context['budget_range'] = entities['budget_range']
        
        if entities['localities']:
            self.user_context['interested_areas'] = entities['localities']
        
        if 'first time' in message or 'beginner' in message:
            self.user_context['experience_level'] = 'beginner'
        elif 'experienced' in message or 'investor' in message:
            self.user_context['experience_level'] = 'experienced'
        
        if 'rental' in message or 'rent' in message:
            self.user_context['investment_goal'] = 'rental_income'
        elif 'appreciation' in message or 'growth' in message:
            self.user_context['investment_goal'] = 'capital_appreciation'
    
    def generate_response(self, message, entities):
        """Generate appropriate response based on message and entities"""
        
        # Check for specific queries first (priority order)
        if self.is_investment_advice(message, entities):
            return self.handle_investment_advice(message, entities)
        
        elif self.is_roi_calculation(message, entities):
            return self.handle_roi_calculation(message, entities)
        
        elif self.is_locality_query(message, entities):
            return self.handle_locality_query(message, entities)
        
        elif self.is_comparison_query(message, entities):
            return self.handle_comparison_query(message, entities)
        
        elif self.is_emi_calculation(message, entities):
            return self.handle_emi_calculation(message, entities)
        
        elif self.is_risk_assessment(message, entities):
            return self.handle_risk_assessment(message, entities)
        
        elif self.is_rental_yield_query(message, entities):
            return self.handle_rental_yield(message, entities)
        
        elif self.is_market_trend_query(message):
            return self.handle_market_trends(message)
        
        elif self.is_affordability_query(message, entities):
            return self.handle_affordability(message, entities)
        
        # Pattern matching for general responses
        for intent, (pattern, responses) in self.patterns.items():
            if re.search(pattern, message, re.IGNORECASE):
                return random.choice(responses)
        
        # Context-aware default response
        return self.get_contextual_response(message, entities)
    
    def is_investment_advice(self, message, entities):
        """Check if user wants investment advice"""
        advice_keywords = ['investment advice', 'recommend', 'suggest', 'budget', 'crore', 'where to invest', 'portfolio', 'strategy']
        return any(keyword in message for keyword in advice_keywords)
    
    def handle_investment_advice(self, message, entities):
        """Handle investment advice requests with comprehensive analysis"""
        try:
            # Determine budget
            budget_lakhs = None
            if entities['prices']:
                budget_lakhs = max(entities['prices'])
            elif 'crore' in message:
                crore_matches = re.findall(r'(\d+(?:\.\d+)?)\s*crore', message)
                if crore_matches:
                    budget_lakhs = float(crore_matches[0]) * 100
                else:
                    budget_lakhs = 100  # Default 1 crore
            
            if budget_lakhs:
                if budget_lakhs >= 200:  # 2+ crores
                    return self.get_premium_investment_advice(budget_lakhs)
                elif budget_lakhs >= 100:  # 1-2 crores
                    return self.get_high_budget_advice(budget_lakhs)
                elif budget_lakhs >= 50:  # 50L - 1 crore
                    return self.get_medium_budget_advice(budget_lakhs)
                else:  # Under 50L
                    return self.get_budget_friendly_advice(budget_lakhs)
            else:
                return self.get_general_investment_advice()
                
        except Exception as e:
            return "I'd love to help with investment advice! Please specify your budget (e.g., ‚Çπ50 lakhs, ‚Çπ1 crore) and I'll provide detailed recommendations."
    
    def get_premium_investment_advice(self, budget_lakhs):
        """Investment advice for 2+ crore budget"""
        return f"""üíé **Premium Investment Strategy for ‚Çπ{budget_lakhs/100:.1f} Crore Portfolio**

**üè¢ DIVERSIFIED PREMIUM PORTFOLIO:**

**Tier 1: Premium Properties (40% - ‚Çπ{budget_lakhs*0.4/100:.1f} Cr)**
‚Ä¢ **Bandra West/Juhu**: ‚Çπ80L-1.2Cr (Prime location, celebrity area)
‚Ä¢ **Lower Parel/Worli**: ‚Çπ70L-1Cr (Business district, high appreciation)
‚Ä¢ **Powai**: ‚Çπ60L-80L (IT hub, consistent demand)

**Tier 2: Growth Areas (35% - ‚Çπ{budget_lakhs*0.35/100:.1f} Cr)**
‚Ä¢ **Thane/Ghodbunder Road**: ‚Çπ40L-60L (Infrastructure boom)
‚Ä¢ **Goregaon/Malad**: ‚Çπ35L-50L (Metro connectivity)
‚Ä¢ **Kandivali/Borivali**: ‚Çπ30L-45L (Established suburbs)

**Tier 3: Emerging Markets (20% - ‚Çπ{budget_lakhs*0.2/100:.1f} Cr)**
‚Ä¢ **Kalyan/Dombivli**: ‚Çπ25L-35L (Affordable, high growth)
‚Ä¢ **Vasai/Virar**: ‚Çπ20L-30L (Future potential)

**Cash Reserve (5% - ‚Çπ{budget_lakhs*0.05/100:.1f} Cr)**
‚Ä¢ Market opportunities & emergencies

**üìä EXPECTED PORTFOLIO RETURNS:**
‚Ä¢ **Rental Yield**: 7-12% annually
‚Ä¢ **Capital Appreciation**: 10-15% annually
‚Ä¢ **Total ROI**: 15-25% potential
‚Ä¢ **Risk Level**: Balanced (Medium)

**üéØ STRATEGIC ADVANTAGES:**
‚úÖ Geographic diversification across Mumbai
‚úÖ Price point diversification (‚Çπ20L to ‚Çπ1.2Cr)
‚úÖ Mix of established and emerging areas
‚úÖ Balanced rental income and appreciation
‚úÖ Liquidity options across segments

**üìà 5-YEAR PROJECTION:**
‚Ä¢ Portfolio Value: ‚Çπ{budget_lakhs*1.8/100:.1f} - ‚Çπ{budget_lakhs*2.2/100:.1f} Crores
‚Ä¢ Annual Income: ‚Çπ{budget_lakhs*0.08:.0f}L - ‚Çπ{budget_lakhs*0.12:.0f}L
‚Ä¢ Total Returns: 80-120% over 5 years

**üîó Next Steps:**
‚Ä¢ Detailed area analysis for each tier
‚Ä¢ Property inspection and due diligence
‚Ä¢ Financing strategy optimization
‚Ä¢ Legal documentation review

Want specific analysis for any tier or area? Just ask!"""
    
    def get_high_budget_advice(self, budget_lakhs):
        """Investment advice for 1-2 crore budget"""
        return f"""üí∞ **Strategic Investment Plan for ‚Çπ{budget_lakhs/100:.1f} Crore Budget**

**üè† BALANCED PORTFOLIO APPROACH:**

**Primary Investment (60% - ‚Çπ{budget_lakhs*0.6:.0f}L)**
‚Ä¢ **Powai/Hiranandani**: ‚Çπ50-70L (IT professionals, stable demand)
‚Ä¢ **Thane West**: ‚Çπ45-65L (Infrastructure development, metro coming)
‚Ä¢ **Goregaon East**: ‚Çπ40-60L (Commercial hub, good connectivity)

**Secondary Investment (30% - ‚Çπ{budget_lakhs*0.3:.0f}L)**
‚Ä¢ **Malad/Kandivali**: ‚Çπ25-40L (Established areas, metro connectivity)
‚Ä¢ **Kalyan/Dombivli**: ‚Çπ20-35L (High growth potential, affordability)

**Opportunity Fund (10% - ‚Çπ{budget_lakhs*0.1:.0f}L)**
‚Ä¢ Market corrections, distress sales, new launches

**üìä EXPECTED RETURNS:**
‚Ä¢ **Rental Yield**: 8-12% annually
‚Ä¢ **Capital Appreciation**: 8-12% annually  
‚Ä¢ **Total ROI**: 14-20% potential
‚Ä¢ **Payback Period**: 6-8 years

**üéØ RECOMMENDED STRATEGY:**
1. **Start with Tier 1** (Powai/Thane) - Lower risk, steady returns
2. **Add Tier 2** within 6 months - Higher growth potential
3. **Keep opportunity fund** liquid for 12-18 months
4. **Reinvest returns** for compounding effect

**üöá INFRASTRUCTURE ADVANTAGE:**
‚Ä¢ Metro Line 2B (Thane-Powai corridor)
‚Ä¢ Coastal Road (Worli-Versova connectivity)
‚Ä¢ Mumbai Trans Harbour Link (Thane connectivity)

**üí° PRO TIPS:**
‚Ä¢ Buy during monsoon season (better deals)
‚Ä¢ Focus on 2-3 BHK for rental demand
‚Ä¢ Ensure parking and amenities
‚Ä¢ Check builder reputation and delivery record

**üîó Want detailed analysis for specific areas? Ask me about any locality!**"""
    
    def get_medium_budget_advice(self, budget_lakhs):
        """Investment advice for 50L-1 crore budget"""
        return f"""üè† **Smart Investment Strategy for ‚Çπ{budget_lakhs:.0f} Lakh Budget**

**üéØ FOCUSED APPROACH:**

**Option 1: Single Premium Property**
‚Ä¢ **Powai**: ‚Çπ{budget_lakhs*0.8:.0f}L (IT hub, 10-12% ROI)
‚Ä¢ **Thane West**: ‚Çπ{budget_lakhs*0.85:.0f}L (Growth area, 12-14% ROI)
‚Ä¢ **Goregaon**: ‚Çπ{budget_lakhs*0.9:.0f}L (Established, 8-10% ROI)

**Option 2: Dual Investment**
‚Ä¢ **Primary**: ‚Çπ{budget_lakhs*0.6:.0f}L in Thane/Kalyan
‚Ä¢ **Secondary**: ‚Çπ{budget_lakhs*0.3:.0f}L in emerging area
‚Ä¢ **Reserve**: ‚Çπ{budget_lakhs*0.1:.0f}L for opportunities

**üìä EXPECTED PERFORMANCE:**
‚Ä¢ **Monthly Rental**: ‚Çπ{budget_lakhs*0.008:.0f} - ‚Çπ{budget_lakhs*0.012:.0f}
‚Ä¢ **Annual ROI**: 10-15%
‚Ä¢ **5-Year Growth**: 60-80%

**üéØ TOP RECOMMENDATIONS:**

**1. THANE (Best Overall)**
‚Ä¢ Price Range: ‚Çπ{budget_lakhs*0.7:.0f}L - ‚Çπ{budget_lakhs:.0f}L
‚Ä¢ ROI: 12-15%
‚Ä¢ Growth Drivers: Metro, IT parks, infrastructure

**2. KALYAN (High Growth)**
‚Ä¢ Price Range: ‚Çπ{budget_lakhs*0.5:.0f}L - ‚Çπ{budget_lakhs*0.8:.0f}L  
‚Ä¢ ROI: 14-18%
‚Ä¢ Growth Drivers: Affordability, connectivity

**3. POWAI (Stable)**
‚Ä¢ Price Range: ‚Çπ{budget_lakhs*0.8:.0f}L - ‚Çπ{budget_lakhs:.0f}L
‚Ä¢ ROI: 8-12%
‚Ä¢ Growth Drivers: IT sector, established market

**üí∞ FINANCING STRATEGY:**
‚Ä¢ Down Payment: ‚Çπ{budget_lakhs*0.2:.0f}L (20%)
‚Ä¢ Home Loan: ‚Çπ{budget_lakhs*0.8:.0f}L (80%)
‚Ä¢ EMI: ‚Çπ{budget_lakhs*0.8*0.008:.0f} (approx)

**üîó Ready for detailed area analysis? Ask about any specific locality!**"""
    
    def get_budget_friendly_advice(self, budget_lakhs):
        """Investment advice for under 50L budget"""
        return f"""üåü **Smart Entry Strategy for ‚Çπ{budget_lakhs:.0f} Lakh Budget**

**üéØ HIGH-GROWTH OPPORTUNITIES:**

**Tier 1: Best Value (‚Çπ{budget_lakhs*0.8:.0f}L - ‚Çπ{budget_lakhs:.0f}L)**
‚Ä¢ **Kalyan East**: 15-18% ROI, excellent connectivity
‚Ä¢ **Dombivli**: 14-16% ROI, family-friendly area
‚Ä¢ **Vasai East**: 16-20% ROI, emerging market

**Tier 2: Ultra Affordable (‚Çπ{budget_lakhs*0.6:.0f}L - ‚Çπ{budget_lakhs*0.8:.0f}L)**
‚Ä¢ **Virar**: 18-22% ROI, highest growth potential
‚Ä¢ **Badlapur**: 16-19% ROI, industrial growth
‚Ä¢ **Ambernath**: 17-20% ROI, upcoming area

**üìä EXPECTED RETURNS:**
‚Ä¢ **Monthly Rental**: ‚Çπ{budget_lakhs*0.012:.0f} - ‚Çπ{budget_lakhs*0.018:.0f}
‚Ä¢ **Annual ROI**: 14-22%
‚Ä¢ **3-Year Growth**: 50-70%

**üöÄ GROWTH CATALYSTS:**
‚Ä¢ Mumbai Metro expansion
‚Ä¢ Industrial corridor development  
‚Ä¢ IT park establishments
‚Ä¢ Infrastructure projects

**üí° SMART STRATEGY:**
1. **Start with Kalyan/Dombivli** (proven track record)
2. **Focus on 1-2 BHK** (high rental demand)
3. **Near railway stations** (connectivity premium)
4. **Ready possession** (immediate rental income)

**üéØ INVESTMENT TIMELINE:**
‚Ä¢ **Month 1-2**: Property search and finalization
‚Ä¢ **Month 3**: Documentation and registration
‚Ä¢ **Month 4**: Rental tenant acquisition
‚Ä¢ **Year 1**: 14-18% returns expected
‚Ä¢ **Year 3**: 50-70% capital appreciation

**üîó Want specific property recommendations in any area? Just ask!**"""
    
    def get_general_investment_advice(self):
        """General investment advice when budget is not specified"""
        return """üí° **Mumbai Real Estate Investment Guide**

**üéØ BUDGET-WISE RECOMMENDATIONS:**

**‚Çπ20-40 Lakhs (Entry Level)**
‚Ä¢ **Areas**: Kalyan, Dombivli, Vasai, Virar
‚Ä¢ **ROI**: 15-22% annually
‚Ä¢ **Strategy**: High growth, emerging markets

**‚Çπ40-70 Lakhs (Mid Range)**  
‚Ä¢ **Areas**: Thane, Malad, Kandivali, Goregaon
‚Ä¢ **ROI**: 10-15% annually
‚Ä¢ **Strategy**: Balanced growth and stability

**‚Çπ70L-1 Crore (Premium)**
‚Ä¢ **Areas**: Powai, Andheri, Bandra (outskirts)
‚Ä¢ **ROI**: 8-12% annually
‚Ä¢ **Strategy**: Stable returns, prime locations

**‚Çπ1+ Crore (Luxury)**
‚Ä¢ **Areas**: Bandra, Juhu, Lower Parel, Worli
‚Ä¢ **ROI**: 6-10% annually
‚Ä¢ **Strategy**: Capital appreciation, prestige

**üìä INVESTMENT PRINCIPLES:**

**üéØ Location Factors:**
‚Ä¢ Metro/railway connectivity
‚Ä¢ IT hubs and commercial areas
‚Ä¢ Schools, hospitals, malls nearby
‚Ä¢ Future infrastructure projects

**üí∞ Financial Planning:**
‚Ä¢ 20-25% down payment
‚Ä¢ EMI should be <40% of income
‚Ä¢ Keep 6-month EMI as emergency fund
‚Ä¢ Consider rental income vs EMI

**üìà Market Timing:**
‚Ä¢ **Best to Buy**: Monsoon season, year-end
‚Ä¢ **Avoid**: Festival seasons, new launch hype
‚Ä¢ **Hold Period**: Minimum 3-5 years
‚Ä¢ **Exit Strategy**: Plan before buying

**üîó Ready to get specific advice? Tell me your budget and I'll create a personalized strategy!**"""
    
    def is_roi_calculation(self, message, entities):
        """Check if user wants ROI calculation"""
        roi_keywords = ['roi', 'return', 'calculate', 'profit', 'yield']
        return any(keyword in message for keyword in roi_keywords) and (entities['localities'] or entities['prices'])
    
    def handle_roi_calculation(self, message, entities):
        """Handle ROI calculation requests"""
        try:
            if entities['localities'] and entities['prices']:
                locality = entities['localities'][0]
                price = entities['prices'][0]
                
                # Use your existing ROI calculation
                roi = self.ml_service.calculate_roi_fallback(locality, price)
                
                if roi:
                    locality_stats = self.ml_service.get_locality_stats(locality)
                    
                    # Calculate additional metrics
                    monthly_rent = locality_stats['avg_rent']
                    annual_rent = monthly_rent * 12
                    property_value = price * 100000
                    
                    response = f"""üéØ **Comprehensive ROI Analysis for {locality.title()}**

**üí∞ INVESTMENT OVERVIEW:**
‚Ä¢ **Property Price**: ‚Çπ{price} Lakhs
‚Ä¢ **Expected Monthly Rent**: ‚Çπ{monthly_rent:,.0f}
‚Ä¢ **Annual Rental Income**: ‚Çπ{annual_rent:,.0f}

**üìà ROI BREAKDOWN:**
‚Ä¢ **Predicted ROI**: {roi:.2f}% annually
‚Ä¢ **Market Average ROI**: {locality_stats['avg_roi']:.2f}%
‚Ä¢ **Rental Yield**: {(annual_rent/property_value)*100:.2f}%

**üìä MARKET COMPARISON:**
‚Ä¢ **Area Price Range**: ‚Çπ{locality_stats['price_range']['min']:.1f}L - ‚Çπ{locality_stats['price_range']['max']:.1f}L
‚Ä¢ **ROI Range**: {locality_stats['roi_range']['min']:.1f}% - {locality_stats['roi_range']['max']:.1f}%
‚Ä¢ **Average Rate/sqft**: ‚Çπ{locality_stats['avg_rate_sqft']:,.0f}

**üí° INVESTMENT INSIGHT:**
"""
                    if roi > locality_stats['avg_roi']:
                        response += f"‚úÖ **Excellent Choice!** Your ROI of {roi:.2f}% is {roi - locality_stats['avg_roi']:.1f}% above the market average.\n"
                        response += "üöÄ This property offers above-average returns for the area."
                    elif roi >= locality_stats['avg_roi'] * 0.9:
                        response += f"‚úÖ **Good Investment!** Your ROI of {roi:.2f}% is close to market average.\n"
                        response += "üìà Solid investment with market-aligned returns."
                    else:
                        response += f"‚ö†Ô∏è **Consider Carefully** - Your ROI of {roi:.2f}% is {locality_stats['avg_roi'] - roi:.1f}% below market average.\n"
                        response += "üí≠ You might want to negotiate the price or explore other options."
                    
                    # Add investment recommendations
                    response += f"""

**üéØ INVESTMENT RECOMMENDATIONS:**
‚Ä¢ **Break-even Period**: {property_value / annual_rent:.1f} years
‚Ä¢ **Monthly Cash Flow**: ‚Çπ{monthly_rent - (price * 1000):.0f} (after ‚Çπ{price * 1000:.0f} EMI estimate)
‚Ä¢ **5-Year Projection**: ‚Çπ{property_value * 1.5 / 100000:.1f}L - ‚Çπ{property_value * 1.8 / 100000:.1f}L

**üìã NEXT STEPS:**
‚Ä¢ Verify actual rental rates in the area
‚Ä¢ Check property condition and legal documents
‚Ä¢ Compare with 2-3 similar properties
‚Ä¢ Consider financing options and EMI impact

üîó Want detailed investment analysis? Use our [Investment Calculator](/investment-calculator)
üó∫Ô∏è See area performance: [ROI Heatmap](/roi-heatmap)"""
                    
                    return response
                else:
                    return f"‚ùå Sorry, I don't have enough data for {locality.title()}. Try popular areas like Andheri, Bandra, Thane, Powai, or Goregaon."
            
            elif entities['localities']:
                locality = entities['localities'][0]
                stats = self.ml_service.get_locality_stats(locality)
                if stats:
                    return f"""üìç **ROI Information for {locality.title()}**
                    
**üìä Market Overview:**
‚Ä¢ **Average ROI**: {stats['avg_roi']:.2f}% annually
‚Ä¢ **ROI Range**: {stats['roi_range']['min']:.1f}% - {stats['roi_range']['max']:.1f}%
‚Ä¢ **Average Price**: ‚Çπ{stats['avg_price']:.1f} Lakhs
‚Ä¢ **Average Rent**: ‚Çπ{stats['avg_rent']:,.0f}/month

To calculate ROI for a specific property, tell me your budget!
Example: "Calculate ROI for ‚Çπ{stats['avg_price']:.0f}L property in {locality.title()}" """
                else:
                    return f"I can calculate ROI for {locality.title()}! What's your property budget? (e.g., ‚Çπ50 lakhs)"
            
            elif entities['prices']:
                price = entities['prices'][0]
                return f"I can calculate ROI for ‚Çπ{price} lakhs! Which locality are you considering? Popular options: Andheri, Bandra, Thane, Powai, Goregaon."
            
            else:
                return """üßÆ **ROI Calculator Ready!**
                
I can calculate detailed ROI analysis including:
‚Ä¢ Annual return percentage
‚Ä¢ Monthly rental income potential  
‚Ä¢ Break-even period
‚Ä¢ Market comparison
‚Ä¢ Investment recommendations

**Just tell me:**
‚Ä¢ Locality name (e.g., Andheri, Thane, Powai)
‚Ä¢ Property price (e.g., ‚Çπ50 lakhs, ‚Çπ1 crore)

**Example**: "Calculate ROI for ‚Çπ60L property in Thane" """
        
        except Exception as e:
            return "Sorry, I encountered an error calculating ROI. Please try again with format: 'Calculate ROI for ‚Çπ[amount] in [locality]'"
    
    def is_locality_query(self, message, entities):
        """Check if user wants locality information"""
        return entities['localities'] or any(word in message for word in ['tell me about', 'information about', 'locality', 'area', 'neighborhood'])
    
    def handle_locality_query(self, message, entities):
        """Handle locality information requests"""
        if entities['localities']:
            locality = entities['localities'][0]
            stats = self.ml_service.get_locality_stats(locality)
            
            if stats:
                # Determine locality category
                category = self.get_locality_category(locality.lower())
                
                return f"""üìç **Complete Guide to {locality.title()}**

**üè† MARKET OVERVIEW:**
‚Ä¢ **Category**: {category}
‚Ä¢ **Average Property Price**: ‚Çπ{stats['avg_price']:.1f} Lakhs
‚Ä¢ **Price Range**: ‚Çπ{stats['price_range']['min']:.1f}L - ‚Çπ{stats['price_range']['max']:.1f}L
‚Ä¢ **Average Rent**: ‚Çπ{stats['avg_rent']:,.0f}/month
‚Ä¢ **Rate per sqft**: ‚Çπ{stats['avg_rate_sqft']:,.0f}

**üìà INVESTMENT METRICS:**
‚Ä¢ **Average ROI**: {stats['avg_roi']:.2f}% annually
‚Ä¢ **ROI Range**: {stats['roi_range']['min']:.1f}% - {stats['roi_range']['max']:.1f}%
‚Ä¢ **Investment Grade**: {self.get_investment_grade(stats['avg_roi'])}

**üéØ AREA HIGHLIGHTS:**
{self.get_locality_highlights(locality.lower())}

**üí° INVESTMENT INSIGHT:**
{self.get_detailed_locality_insight(stats, locality.lower())}

**üîó QUICK ACTIONS:**
‚Ä¢ Calculate ROI: "ROI for ‚Çπ{stats['avg_price']:.0f}L in {locality.title()}"
‚Ä¢ Compare areas: "Compare {locality.title()} vs [other area]"
‚Ä¢ Investment advice: "Investment advice for {locality.title()}"

Want more specific information about {locality.title()}? Just ask!"""
            else:
                return f"""üìç **{locality.title()} Information**
                
I don't have detailed market data for {locality.title()} yet, but I can help you with:

**üè† Popular Mumbai Areas I Cover:**
‚Ä¢ **Premium**: Bandra, Juhu, Worli, Lower Parel
‚Ä¢ **Established**: Andheri, Powai, Goregaon, Malad  
‚Ä¢ **Emerging**: Thane, Kalyan, Vasai, Virar
‚Ä¢ **Commercial**: BKC, Nariman Point, Fort

**üí° Alternative Suggestions:**
Try asking about nearby areas like Andheri, Thane, or Powai for detailed analysis.

**üîó Or explore:**
‚Ä¢ [ROI Heatmap](/roi-heatmap) for visual area comparison
‚Ä¢ [Market Comparison](/market-comparison) for side-by-side analysis"""
        else:
            return """üè† **Mumbai Locality Guide**
            
Which area would you like to know about? I have comprehensive data on:

**üåü PREMIUM AREAS:**
‚Ä¢ Bandra, Juhu, Worli, Lower Parel, Marine Drive

**üèòÔ∏è ESTABLISHED SUBURBS:**  
‚Ä¢ Andheri, Powai, Goregaon, Malad, Kandivali, Borivali

**üöÄ EMERGING HOTSPOTS:**
‚Ä¢ Thane, Kalyan, Dombivli, Vasai, Virar

**üè¢ COMMERCIAL HUBS:**
‚Ä¢ BKC, Nariman Point, Fort, Andheri East

**Just ask**: "Tell me about [area name]" or "Information about Thane"

I'll provide detailed market analysis, investment insights, and recommendations!"""
    
    def get_locality_category(self, locality):
        """Determine locality category"""
        if locality in self.knowledge_base['mumbai_areas']['premium']:
            return "Premium/Luxury"
        elif locality in self.knowledge_base['mumbai_areas']['emerging']:
            return "Emerging/High Growth"
        elif locality in self.knowledge_base['mumbai_areas']['established']:
            return "Established Suburb"
        elif locality in self.knowledge_base['mumbai_areas']['commercial']:
            return "Commercial Hub"
        else:
            return "Residential Area"
    
    def get_investment_grade(self, roi):
        """Get investment grade based on ROI"""
        if roi >= 12:
            return "A+ (Excellent)"
        elif roi >= 10:
            return "A (Very Good)"
        elif roi >= 8:
            return "B+ (Good)"
        elif roi >= 6:
            return "B (Average)"
        else:
            return "C (Below Average)"
    
    def get_locality_highlights(self, locality):
        """Get specific highlights for localities"""
        highlights = {
            'andheri': "‚Ä¢ Bollywood hub with film studios\n‚Ä¢ Excellent metro and airport connectivity\n‚Ä¢ Mix of commercial and residential\n‚Ä¢ Good rental demand from professionals",
            'bandra': "‚Ä¢ Celebrity and upscale residential area\n‚Ä¢ Bandra-Kurla Complex nearby\n‚Ä¢ Premium shopping and dining\n‚Ä¢ High capital appreciation potential",
            'thane': "‚Ä¢ Rapidly developing infrastructure\n‚Ä¢ Upcoming metro connectivity\n‚Ä¢ IT parks and commercial growth\n‚Ä¢ More affordable than central Mumbai",
            'powai': "‚Ä¢ Major IT hub with Hiranandani Gardens\n‚Ä¢ Premium residential complexes\n‚Ä¢ Good schools and healthcare\n‚Ä¢ Consistent rental demand",
            'goregaon': "‚Ä¢ Film City and entertainment industry\n‚Ä¢ Metro connectivity (Line 1)\n‚Ä¢ Balanced residential and commercial\n‚Ä¢ Good connectivity to western suburbs",
            'malad': "‚Ä¢ Growing commercial and IT sector\n‚Ä¢ Metro Line 7 connectivity\n‚Ä¢ Mix of affordable and premium housing\n‚Ä¢ Good infrastructure development"
        }
        return highlights.get(locality, "‚Ä¢ Developing residential area\n‚Ä¢ Good connectivity options\n‚Ä¢ Growing infrastructure\n‚Ä¢ Investment potential")
    
    def get_detailed_locality_insight(self, stats, locality):
        """Get detailed investment insight for locality"""
        roi = stats['avg_roi']
        price = stats['avg_price']
        
        if roi >= 10 and price <= 60:
            return "üî• **High ROI + Affordable**: Excellent for rental income investors and first-time buyers."
        elif roi >= 8 and price >= 80:
            return "üíé **Balanced Premium**: Good for long-term capital appreciation with decent rental yields."
        elif roi >= 12:
            return "üöÄ **ROI Superstar**: Outstanding returns, perfect for income-focused investors."
        elif price >= 100:
            return "üèÜ **Premium Market**: Focus on capital appreciation, prestige location."
        else:
            return "üìà **Steady Growth**: Reliable investment with balanced risk-reward profile."
    
    def is_comparison_query(self, message, entities):
        """Check if user wants to compare localities"""
        return len(entities['localities']) >= 2 or any(word in message for word in ['compare', 'vs', 'versus', 'difference', 'better'])
    
    def handle_comparison_query(self, message, entities):
        """Handle locality comparison requests"""
        if len(entities['localities']) >= 2:
            loc1, loc2 = entities['localities'][0], entities['localities'][1]
            comparison = self.ml_service.compare_localities(loc1, loc2)
            
            if comparison:
                return f"""‚öñÔ∏è **Detailed Comparison: {loc1.title()} vs {loc2.title()}**

**üìä HEAD-TO-HEAD ANALYSIS:**

**{loc1.title()}:**
üè† **Price**: ‚Çπ{comparison['loc1']['stats']['avg_price']:.1f}L | üìà **ROI**: {comparison['loc1']['stats']['avg_roi']:.1f}% | üè° **Rent**: ‚Çπ{comparison['loc1']['stats']['avg_rent']:,.0f}

**{loc2.title()}:**  
üè† **Price**: ‚Çπ{comparison['loc2']['stats']['avg_price']:.1f}L | üìà **ROI**: {comparison['loc2']['stats']['avg_roi']:.1f}% | üè° **Rent**: ‚Çπ{comparison['loc2']['stats']['avg_rent']:,.0f}

**üèÜ WINNER ANALYSIS:**
‚Ä¢ **üí∞ More Affordable**: {comparison['comparison']['better_price']} (‚Çπ{abs(comparison['comparison']['price_difference']):.1f}L difference)
‚Ä¢ **üìà Better ROI**: {comparison['comparison']['better_roi']} ({abs(comparison['comparison']['roi_difference']):.1f}% higher)
‚Ä¢ **üè° Higher Rent**: {comparison['comparison']['better_rent']} (‚Çπ{abs(comparison['comparison']['rent_difference']):,.0f} more)

**üéØ INVESTMENT RECOMMENDATION:**

**For Rental Income Focus:**
Choose **{comparison['comparison']['better_roi']}** - Higher ROI means better rental returns

**For Affordability:**
Choose **{comparison['comparison']['better_price']}** - Lower entry cost, easier financing

**For Premium Investment:**
Choose the area with higher absolute rent potential

**üìã DETAILED COMPARISON:**
‚Ä¢ **Price Difference**: ‚Çπ{abs(comparison['comparison']['price_difference']):.1f} Lakhs
‚Ä¢ **ROI Difference**: {abs(comparison['comparison']['roi_difference']):.1f}% annually  
‚Ä¢ **Rent Difference**: ‚Çπ{abs(comparison['comparison']['rent_difference']):,.0f} monthly

üîó [Visual Comparison](/market-comparison) | [Detailed Analysis](/investment-calculator)"""
            else:
                return f"Sorry, I couldn't compare {loc1.title()} and {loc2.title()}. Please ensure both are valid Mumbai localities I have data for."
        else:
            return """‚öñÔ∏è **Area Comparison Tool**
            
I can compare any two Mumbai localities for you! Just specify the areas.

**Examples:**
‚Ä¢ "Compare Andheri and Bandra"
‚Ä¢ "Thane vs Powai comparison"  
‚Ä¢ "Which is better - Malad or Goregaon?"

**I'll analyze:**
‚Ä¢ Property prices and affordability
‚Ä¢ ROI and rental yields
‚Ä¢ Market trends and growth potential
‚Ä¢ Investment recommendations
‚Ä¢ Risk factors

**Popular Comparisons:**
‚Ä¢ Andheri vs Bandra (Established vs Premium)
‚Ä¢ Thane vs Kalyan (Emerging markets)
‚Ä¢ Powai vs Goregaon (IT hubs)
‚Ä¢ Malad vs Kandivali (Suburbs)

Which areas would you like me to compare?"""
    
    def is_emi_calculation(self, message, entities):
        """Check if user wants EMI calculation"""
        return any(word in message for word in ['emi', 'loan', 'mortgage', 'monthly payment', 'installment'])
    
    def handle_emi_calculation(self, message, entities):
        """Handle EMI calculation requests"""
        try:
            numbers = entities['numbers']
            percentages = entities['percentages']
            
            # Extract loan details
            loan_amount = None
            tenure = 20  # Default
            interest_rate = 8.5  # Default
            
            if entities['prices']:
                loan_amount = entities['prices'][0]
            elif numbers:
                loan_amount = numbers[0]
            
            if len(numbers) >= 2:
                tenure = numbers[1]
            
            if percentages:
                interest_rate = percentages[0]
            
            if loan_amount:
                # Calculate EMI
                principal = loan_amount * 100000  # Convert to actual amount
                monthly_rate = interest_rate / (12 * 100)
                total_months = tenure * 12
                
                if monthly_rate > 0:
                    emi = (principal * monthly_rate * (1 + monthly_rate) ** total_months) / \
                          ((1 + monthly_rate) ** total_months - 1)
                else:
                    emi = principal / total_months
                
                total_payment = emi * total_months
                total_interest = total_payment - principal
                
                return f"""üí≥ **Comprehensive EMI Analysis**

**üè† LOAN DETAILS:**
‚Ä¢ **Loan Amount**: ‚Çπ{loan_amount} Lakhs
‚Ä¢ **Interest Rate**: {interest_rate}% per annum
‚Ä¢ **Tenure**: {tenure} years ({total_months} months)

**üí∞ EMI BREAKDOWN:**
‚Ä¢ **Monthly EMI**: ‚Çπ{emi:,.0f}
‚Ä¢ **Total Amount Payable**: ‚Çπ{total_payment/100000:.1f} Lakhs
‚Ä¢ **Total Interest**: ‚Çπ{total_interest/100000:.1f} Lakhs
‚Ä¢ **Interest %**: {(total_interest/principal)*100:.1f}% of loan amount

**üìä AFFORDABILITY ANALYSIS:**
‚Ä¢ **Required Monthly Income**: ‚Çπ{emi*2.5:,.0f} (40% EMI rule)
‚Ä¢ **Annual Income Needed**: ‚Çπ{emi*30:,.0f}
‚Ä¢ **Down Payment (20%)**: ‚Çπ{loan_amount*0.25:.1f} Lakhs

**üí° SMART TIPS:**
‚Ä¢ EMI should be <40% of monthly income
‚Ä¢ Consider floating vs fixed rates
‚Ä¢ Factor in processing fees (0.5-1% of loan)
‚Ä¢ Keep 6-month EMI as emergency fund

**üéØ OPTIMIZATION OPTIONS:**
‚Ä¢ **Longer Tenure**: ‚Çπ{(principal * (interest_rate/1200) * (1 + interest_rate/1200)**(25*12)) / ((1 + interest_rate/1200)**(25*12) - 1):,.0f} EMI for 25 years
‚Ä¢ **Higher Down Payment**: Reduce loan amount to lower EMI
‚Ä¢ **Prepayment**: Save ‚Çπ{total_interest*0.3/100000:.1f}L+ with annual prepayments

üîó Need investment analysis? Try our [Investment Calculator](/investment-calculator)"""
            else:
                return """üí≥ **EMI Calculator Ready!**
                
I can calculate detailed EMI analysis for your home loan.

**Just provide:**
‚Ä¢ **Loan Amount** (e.g., ‚Çπ50 lakhs, ‚Çπ80 lakhs)
‚Ä¢ **Interest Rate** (e.g., 8.5%, 9.2%) - Optional, I'll use current rates
‚Ä¢ **Tenure** (e.g., 20 years, 25 years) - Optional, default is 20 years

**Examples:**
‚Ä¢ "EMI for ‚Çπ60L at 8.5% for 20 years"
‚Ä¢ "Calculate EMI for ‚Çπ80 lakh loan"
‚Ä¢ "Monthly payment for ‚Çπ1 crore home loan"

**I'll show you:**
‚Ä¢ Monthly EMI amount
‚Ä¢ Total interest payable
‚Ä¢ Affordability requirements
‚Ä¢ Optimization suggestions

What loan amount are you considering?"""
        
        except Exception as e:
            return "I can calculate EMI for you! Please provide loan amount and optionally interest rate and tenure. Example: 'EMI for ‚Çπ50L at 8.5% for 20 years'"
    
    def is_risk_assessment(self, message, entities):
        """Check if user wants risk assessment"""
        return any(word in message for word in ['risk', 'risky', 'safe', 'safety', 'secure'])
    
    def handle_risk_assessment(self, message, entities):
        """Handle risk assessment requests"""
        if entities['localities']:
            locality = entities['localities'][0]
            stats = self.ml_service.get_locality_stats(locality)
            
            if stats:
                risk_score = self.calculate_risk_score(stats, locality.lower())
                risk_level = self.get_risk_level(risk_score)
                
                return f"""üõ°Ô∏è **Risk Assessment for {locality.title()}**

**üìä OVERALL RISK SCORE: {risk_score}/100**
**üéØ Risk Level: {risk_level}**

**üîç RISK BREAKDOWN:**

**Market Risk (30%):**
‚Ä¢ ROI Volatility: {self.get_roi_volatility(stats)}
‚Ä¢ Price Stability: {self.get_price_stability(stats)}
‚Ä¢ Market Maturity: {self.get_market_maturity(locality.lower())}

**Location Risk (25%):**
‚Ä¢ Infrastructure: {self.get_infrastructure_risk(locality.lower())}
‚Ä¢ Connectivity: {self.get_connectivity_risk(locality.lower())}
‚Ä¢ Development Stage: {self.get_development_risk(locality.lower())}

**Financial Risk (25%):**
‚Ä¢ Liquidity: {self.get_liquidity_risk(stats)}
‚Ä¢ Entry Cost: {self.get_entry_cost_risk(stats)}
‚Ä¢ Rental Demand: {self.get_rental_demand_risk(locality.lower())}

**External Risk (20%):**
‚Ä¢ Regulatory: {self.get_regulatory_risk(locality.lower())}
‚Ä¢ Economic Factors: {self.get_economic_risk()}
‚Ä¢ Competition: {self.get_competition_risk(locality.lower())}

**üí° RISK MITIGATION STRATEGIES:**
{self.get_risk_mitigation_strategies(risk_level, locality.lower())}

**üéØ INVESTMENT RECOMMENDATION:**
{self.get_risk_based_recommendation(risk_level, stats)}

Want detailed analysis of any specific risk factor? Just ask!"""
            else:
                return f"I can assess investment risks for {locality.title()}! However, I need more market data for detailed analysis. Try popular areas like Andheri, Thane, or Powai for comprehensive risk assessment."
        else:
            return """üõ°Ô∏è **Investment Risk Assessment**
            
I can analyze investment risks for any Mumbai locality!

**Risk Factors I Evaluate:**
‚Ä¢ **Market Risk**: Price volatility, ROI consistency
‚Ä¢ **Location Risk**: Infrastructure, connectivity, development
‚Ä¢ **Financial Risk**: Liquidity, entry cost, rental demand  
‚Ä¢ **External Risk**: Regulations, economic factors

**Just ask:**
‚Ä¢ "Risk assessment for Thane"
‚Ä¢ "Is Powai a safe investment?"
‚Ä¢ "Investment risks in Bandra"

**I'll provide:**
‚Ä¢ Overall risk score (0-100)
‚Ä¢ Detailed risk breakdown
‚Ä¢ Mitigation strategies
‚Ä¢ Investment recommendations

Which area would you like me to assess?"""
    
    def calculate_risk_score(self, stats, locality):
        """Calculate risk score for a locality"""
        base_score = 50
        
        # ROI consistency (lower volatility = lower risk)
        roi_range = stats['roi_range']['max'] - stats['roi_range']['min']
        if roi_range <= 3:
            base_score -= 10
        elif roi_range >= 8:
            base_score += 15
        
        # Price level (very high prices = higher risk)
        if stats['avg_price'] >= 100:
            base_score += 20
        elif stats['avg_price'] <= 40:
            base_score -= 10
        
        # Area maturity
        if locality in self.knowledge_base['mumbai_areas']['premium']:
            base_score -= 5  # Lower risk
        elif locality in self.knowledge_base['mumbai_areas']['emerging']:
            base_score += 15  # Higher risk, higher reward
        
        return max(10, min(90, base_score))
    
    def get_risk_level(self, score):
        """Get risk level based on score"""
        if score <= 30:
            return "üü¢ LOW RISK"
        elif score <= 50:
            return "üü° MODERATE RISK"
        elif score <= 70:
            return "üü† HIGH RISK"
        else:
            return "üî¥ VERY HIGH RISK"
    
    def get_roi_volatility(self, stats):
        """Assess ROI volatility"""
        roi_range = stats['roi_range']['max'] - stats['roi_range']['min']
        if roi_range <= 3:
            return "Low (Stable returns)"
        elif roi_range <= 6:
            return "Moderate (Some fluctuation)"
        else:
            return "High (Volatile returns)"
    
    def get_price_stability(self, stats):
        """Assess price stability"""
        price_range = stats['price_range']['max'] - stats['price_range']['min']
        avg_price = stats['avg_price']
        volatility = (price_range / avg_price) * 100
        
        if volatility <= 30:
            return "Stable (Low price variation)"
        elif volatility <= 60:
            return "Moderate (Some price variation)"
        else:
            return "Volatile (High price variation)"
    
    def get_market_maturity(self, locality):
        """Assess market maturity"""
        if locality in self.knowledge_base['mumbai_areas']['premium']:
            return "Mature (Established market)"
        elif locality in self.knowledge_base['mumbai_areas']['established']:
            return "Developing (Growing market)"
        else:
            return "Emerging (New market)"
    
    def get_infrastructure_risk(self, locality):
        """Assess infrastructure risk"""
        if locality in ['andheri', 'bandra', 'powai']:
            return "Low (Excellent infrastructure)"
        elif locality in ['thane', 'goregaon', 'malad']:
            return "Moderate (Good infrastructure)"
        else:
            return "High (Developing infrastructure)"
    
    def get_connectivity_risk(self, locality):
        """Assess connectivity risk"""
        if locality in ['andheri', 'bandra', 'thane']:
            return "Low (Multiple transport options)"
        elif locality in ['powai', 'goregaon', 'malad']:
            return "Moderate (Good connectivity)"
        else:
            return "High (Limited connectivity)"
    
    def get_development_risk(self, locality):
        """Assess development stage risk"""
        if locality in self.knowledge_base['mumbai_areas']['emerging']:
            return "High (Early development stage)"
        elif locality in self.knowledge_base['mumbai_areas']['established']:
            return "Moderate (Steady development)"
        else:
            return "Low (Fully developed)"
    
    def get_liquidity_risk(self, stats):
        """Assess liquidity risk"""
        if stats['avg_price'] >= 100:
            return "High (Premium properties, limited buyers)"
        elif stats['avg_price'] <= 40:
            return "Low (Affordable, high demand)"
        else:
            return "Moderate (Balanced market)"
    
    def get_entry_cost_risk(self, stats):
        """Assess entry cost risk"""
        if stats['avg_price'] >= 80:
            return "High (High capital requirement)"
        elif stats['avg_price'] <= 50:
            return "Low (Affordable entry)"
        else:
            return "Moderate (Reasonable entry cost)"
    
    def get_rental_demand_risk(self, locality):
        """Assess rental demand risk"""
        if locality in ['powai', 'andheri', 'thane']:
            return "Low (High rental demand)"
        elif locality in ['goregaon', 'malad', 'kandivali']:
            return "Moderate (Steady rental demand)"
        else:
            return "High (Limited rental market)"
    
    def get_regulatory_risk(self, locality):
        """Assess regulatory risk"""
        return "Moderate (Standard Mumbai regulations)"
    
    def get_economic_risk(self):
        """Assess economic risk"""
        return "Moderate (General market conditions)"
    
    def get_competition_risk(self, locality):
        """Assess competition risk"""
        if locality in self.knowledge_base['mumbai_areas']['emerging']:
            return "High (Many new projects)"
        else:
            return "Moderate (Established competition)"
    
    def get_risk_mitigation_strategies(self, risk_level, locality):
        """Get risk mitigation strategies"""
        if "LOW" in risk_level:
            return """‚Ä¢ Maintain property well for consistent returns
‚Ä¢ Consider leveraging for portfolio expansion
‚Ä¢ Focus on long-term holding strategy"""
        elif "MODERATE" in risk_level:
            return """‚Ä¢ Diversify across 2-3 properties if possible
‚Ä¢ Keep 6-month expense reserve
‚Ä¢ Monitor market trends closely
‚Ä¢ Consider professional property management"""
        else:
            return """‚Ä¢ Limit exposure to 20-30% of portfolio
‚Ä¢ Ensure strong rental agreements
‚Ä¢ Keep higher cash reserves (12+ months)
‚Ä¢ Consider exit strategy before buying
‚Ä¢ Get comprehensive insurance coverage"""
    
    def get_risk_based_recommendation(self, risk_level, stats):
        """Get investment recommendation based on risk"""
        if "LOW" in risk_level:
            return f"‚úÖ **RECOMMENDED** - Suitable for conservative investors seeking stable returns of {stats['avg_roi']:.1f}%"
        elif "MODERATE" in risk_level:
            return f"‚ö†Ô∏è **PROCEED WITH CAUTION** - Good for experienced investors comfortable with {stats['avg_roi']:.1f}% returns and moderate risk"
        else:
            return f"üö® **HIGH RISK** - Only for aggressive investors seeking high returns. Consider smaller allocation despite {stats['avg_roi']:.1f}% potential"
    
    def is_rental_yield_query(self, message, entities):
        """Check if user wants rental yield information"""
        return any(word in message for word in ['rental yield', 'rent', 'rental income', 'tenant', 'renting'])
    
    def handle_rental_yield(self, message, entities):
        """Handle rental yield queries"""
        if entities['localities']:
            locality = entities['localities'][0]
            stats = self.ml_service.get_locality_stats(locality)
            
            if stats:
                annual_rent = stats['avg_rent'] * 12
                property_value = stats['avg_price'] * 100000
                rental_yield = (annual_rent / property_value) * 100
                
                return f"""üè† **Rental Yield Analysis for {locality.title()}**

**üí∞ RENTAL METRICS:**
‚Ä¢ **Average Monthly Rent**: ‚Çπ{stats['avg_rent']:,.0f}
‚Ä¢ **Annual Rental Income**: ‚Çπ{annual_rent:,.0f}
‚Ä¢ **Rental Yield**: {rental_yield:.2f}% annually
‚Ä¢ **Gross ROI**: {stats['avg_roi']:.2f}% (including appreciation)

**üìä YIELD BREAKDOWN:**
‚Ä¢ **Rental Component**: {rental_yield:.2f}%
‚Ä¢ **Appreciation Component**: {stats['avg_roi'] - rental_yield:.2f}%
‚Ä¢ **Total Return**: {stats['avg_roi']:.2f}%

**üéØ RENTAL MARKET INSIGHTS:**
‚Ä¢ **Tenant Profile**: {self.get_tenant_profile(locality.lower())}
‚Ä¢ **Rental Demand**: {self.get_rental_demand_level(locality.lower())}
‚Ä¢ **Vacancy Risk**: {self.get_vacancy_risk(locality.lower())}
‚Ä¢ **Rent Growth**: {self.get_rent_growth_potential(locality.lower())}

**üí° RENTAL STRATEGY:**
{self.get_rental_strategy(rental_yield, locality.lower())}

**üìã RENTAL INCOME PROJECTION:**
‚Ä¢ **Year 1**: ‚Çπ{annual_rent:,.0f}
‚Ä¢ **Year 3**: ‚Çπ{annual_rent * 1.15:,.0f} (5% annual growth)
‚Ä¢ **Year 5**: ‚Çπ{annual_rent * 1.28:,.0f} (5% annual growth)

**üîó Want detailed rental analysis? Ask about tenant management or rental agreements!"""
            else:
                return f"I can provide rental yield analysis for {locality.title()}! However, I need more market data. Try areas like Powai, Andheri, or Thane for detailed rental insights."
        else:
            return """üè† **Rental Yield Analysis**
            
I can analyze rental income potential for any Mumbai locality!

**What I'll Show You:**
‚Ä¢ Monthly and annual rental income
‚Ä¢ Rental yield percentage
‚Ä¢ Tenant demographics and demand
‚Ä¢ Vacancy risks and market trends
‚Ä¢ Rental growth projections

**Examples:**
‚Ä¢ "Rental yield in Powai"
‚Ä¢ "Rent potential in Thane"
‚Ä¢ "Rental income for Andheri property"

**Popular High-Yield Areas:**
‚Ä¢ **Powai**: 8-12% yield (IT professionals)
‚Ä¢ **Thane**: 10-14% yield (growing demand)
‚Ä¢ **Kalyan**: 12-16% yield (affordable segment)
‚Ä¢ **Goregaon**: 8-10% yield (established market)

Which area interests you for rental investment?"""
    
    def get_tenant_profile(self, locality):
        """Get typical tenant profile for locality"""
        profiles = {
            'powai': "IT professionals, young couples, corporate executives",
            'andheri': "Film industry professionals, young professionals, families",
            'thane': "Middle-class families, IT professionals, government employees",
            'bandra': "High-income professionals, celebrities, expatriates",
            'goregaon': "Working professionals, small families, students",
            'malad': "Middle-income families, working professionals, students"
        }
        return profiles.get(locality, "Working professionals and families")
    
    def get_rental_demand_level(self, locality):
        """Get rental demand level for locality"""
        if locality in ['powai', 'andheri', 'thane']:
            return "High (Strong consistent demand)"
        elif locality in ['goregaon', 'malad', 'kandivali']:
            return "Moderate (Steady demand)"
        else:
            return "Growing (Increasing demand)"
    
    def get_vacancy_risk(self, locality):
        """Get vacancy risk assessment"""
        if locality in ['powai', 'andheri']:
            return "Low (2-5% typical vacancy)"
        elif locality in ['thane', 'goregaon']:
            return "Moderate (5-8% typical vacancy)"
        else:
            return "Variable (8-12% typical vacancy)"
    
    def get_rent_growth_potential(self, locality):
        """Get rent growth potential"""
        if locality in self.knowledge_base['mumbai_areas']['emerging']:
            return "High (8-12% annual growth potential)"
        elif locality in self.knowledge_base['mumbai_areas']['established']:
            return "Moderate (5-8% annual growth)"
        else:
            return "Stable (3-6% annual growth)"
    
    def get_rental_strategy(self, rental_yield, locality):
        """Get rental strategy recommendations"""
        if rental_yield >= 10:
            return f"""**INCOME-FOCUSED STRATEGY:**
‚Ä¢ Excellent rental yield of {rental_yield:.1f}%
‚Ä¢ Focus on tenant retention and property maintenance
‚Ä¢ Consider leveraging for portfolio expansion
‚Ä¢ Target long-term tenants for stability"""
        elif rental_yield >= 7:
            return f"""**BALANCED STRATEGY:**
‚Ä¢ Good rental yield of {rental_yield:.1f}%
‚Ä¢ Balance between rental income and appreciation
‚Ä¢ Invest in property improvements for higher rents
‚Ä¢ Monitor market for optimization opportunities"""
        else:
            return f"""**APPRECIATION-FOCUSED STRATEGY:**
‚Ä¢ Moderate rental yield of {rental_yield:.1f}%
‚Ä¢ Focus on capital appreciation over rental income
‚Ä¢ Consider premium upgrades to justify higher rents
‚Ä¢ Hold for long-term value growth"""
    
    def is_market_trend_query(self, message):
        """Check if user wants market trends"""
        trend_keywords = ['trends', 'market', 'growth', 'future', 'prediction', 'forecast', 'outlook']
        return any(keyword in message for keyword in trend_keywords)
    
    def handle_market_trends(self, message):
        """Handle market trend queries with comprehensive analysis"""
        try:
            # Get top performing areas from data
            top_areas = []
            if 'summary' in self.ml_service.data and not self.ml_service.data['summary'].empty:
                df = self.ml_service.data['summary']
                top_roi = df.nlargest(5, 'roi_mean')
                for _, row in top_roi.iterrows():
                    top_areas.append({
                        'name': row['locality'].title(),
                        'roi': row['roi_mean']
                    })
            
            return f"""üìà **Mumbai Real Estate Market Trends & Analysis 2024-25**

**üî• CURRENT MARKET HOTSPOTS:**
{self.format_top_areas(top_areas)}

**üìä KEY MARKET INDICATORS:**

**üè† Price Trends:**
‚Ä¢ Suburban areas: 15-20% annual growth
‚Ä¢ Premium locations: 8-12% steady appreciation  
‚Ä¢ Emerging markets: 20-25% rapid growth
‚Ä¢ Overall Mumbai: 12-15% average growth

**üí∞ ROI Performance:**
‚Ä¢ High-yield areas: 12-18% (Kalyan, Dombivli, Vasai)
‚Ä¢ Balanced areas: 8-12% (Thane, Powai, Goregaon)
‚Ä¢ Premium areas: 6-10% (Bandra, Juhu, Worli)

**üöá INFRASTRUCTURE IMPACT:**

**Metro Expansion Effects:**
‚Ä¢ Line 2B (Thane-Powai): 25-30% price boost expected
‚Ä¢ Line 7 (Malad-Kandivali): 20-25% appreciation
‚Ä¢ Coastal Road: 15-20% impact on western suburbs

**üéØ 2024-25 PREDICTIONS:**

**Growth Drivers:**
‚Ä¢ IT sector expansion in Thane/Navi Mumbai
‚Ä¢ Infrastructure completion (Metro, Coastal Road)
‚Ä¢ Affordable housing demand surge
‚Ä¢ Work-from-home trend favoring suburbs

**Market Opportunities:**
‚Ä¢ **Q1-Q2 2024**: Best buying season (monsoon discounts)
‚Ä¢ **Emerging hotspots**: Kalyan, Vasai, Virar showing 20%+ growth
‚Ä¢ **Rental demand**: Sustained high demand, 8-12% rent growth

**üí° INVESTMENT STRATEGY FOR 2024:**

**Short-term (1-2 years):**
‚Ä¢ Focus on ready-to-move properties
‚Ä¢ Target high-rental-yield areas (Thane, Kalyan)
‚Ä¢ Avoid under-construction in uncertain times

**Medium-term (3-5 years):**
‚Ä¢ Invest in metro-connected areas
‚Ä¢ Diversify across 2-3 micro-markets
‚Ä¢ Consider commercial properties in IT hubs

**Long-term (5+ years):**
‚Ä¢ Emerging suburbs with infrastructure plans
‚Ä¢ Land parcels in developing corridors
‚Ä¢ Premium properties for appreciation

**‚ö†Ô∏è RISK FACTORS TO WATCH:**
‚Ä¢ Interest rate fluctuations
‚Ä¢ Regulatory changes in real estate
‚Ä¢ Economic slowdown impact
‚Ä¢ Oversupply in certain micro-markets

**üîó Want specific trend analysis for any area? Just ask!**

**Next Steps:**
‚Ä¢ Explore specific localities: "Trends in Thane"
‚Ä¢ Investment timing: "When to buy in Powai"
‚Ä¢ Sector analysis: "IT hub property trends" """
        
        except Exception as e:
            return """üìà **Mumbai Real Estate Market Trends**

**üî• Current Market Highlights:**
‚Ä¢ Suburban growth outpacing central Mumbai
‚Ä¢ Infrastructure development driving 20%+ appreciation
‚Ä¢ Rental yields strongest in emerging areas
‚Ä¢ Premium locations focusing on capital appreciation

**üìä Key Trends:**
‚Ä¢ **Thane Corridor**: Fastest growing region
‚Ä¢ **Metro Impact**: 25-30% price boost near stations  
‚Ä¢ **IT Hubs**: Sustained rental demand
‚Ä¢ **Affordable Housing**: High demand segment

**üí° Investment Opportunities:**
‚Ä¢ Emerging suburbs for high ROI
‚Ä¢ Metro-connected areas for appreciation
‚Ä¢ IT corridors for rental income

üó∫Ô∏è Check our [Heat Map](/roi-heatmap) for visual market trends!"""
    
    def format_top_areas(self, top_areas):
        """Format top performing areas"""
        if not top_areas:
            return "‚Ä¢ Data being updated - check back soon!"
        
        formatted = ""
        for i, area in enumerate(top_areas, 1):
            emoji = "üî•" if area['roi'] >= 10 else "üìà" if area['roi'] >= 8 else "üìä"
            formatted += f"‚Ä¢ **{area['name']}**: {area['roi']:.1f}% ROI {emoji}\n"
        
        return formatted
    
    def is_affordability_query(self, message, entities):
        """Check if user wants affordability analysis"""
        return any(word in message for word in ['afford', 'affordability', 'budget', 'down payment', 'income'])
    
    def handle_affordability(self, message, entities):
        """Handle affordability queries"""
        try:
            # Extract income or down payment info
            income = None
            down_payment = None
            
            if 'income' in message and entities['numbers']:
                income = entities['numbers'][0] * 1000  # Assume in thousands
            elif 'down payment' in message and entities['prices']:
                down_payment = entities['prices'][0] * 100000  # Convert to actual amount
            
            if income:
                max_emi = income * 0.4  # 40% rule
                max_loan = self.calculate_max_loan(max_emi)
                max_property_value = max_loan / 0.8  # Assuming 20% down payment
                
                return f"""üí∞ **Affordability Analysis**

**üìä BASED ON YOUR INCOME:**
‚Ä¢ **Monthly Income**: ‚Çπ{income:,.0f}
‚Ä¢ **Max EMI (40% rule)**: ‚Çπ{max_emi:,.0f}
‚Ä¢ **Max Loan Amount**: ‚Çπ{max_loan/100000:.1f} Lakhs
‚Ä¢ **Max Property Value**: ‚Çπ{max_property_value/100000:.1f} Lakhs
‚Ä¢ **Required Down Payment**: ‚Çπ{max_property_value*0.2/100000:.1f} Lakhs

**üè† RECOMMENDED AREAS:**
{self.get_affordable_areas(max_property_value/100000)}

**üí° AFFORDABILITY TIPS:**
‚Ä¢ Keep EMI under 40% of income
‚Ä¢ Maintain 6-month EMI emergency fund
‚Ä¢ Factor in maintenance costs (‚Çπ2-3K/month)
‚Ä¢ Consider location vs affordability trade-off

**üìà FINANCING OPTIONS:**
‚Ä¢ **Home Loan**: 80% of property value
‚Ä¢ **Interest Rate**: 8.5-9.5% current range
‚Ä¢ **Tenure**: 15-30 years available
‚Ä¢ **Processing Fee**: 0.5-1% of loan amount

Want specific property recommendations in your budget? Just ask!"""
            
            elif down_payment:
                max_property_value = down_payment / 0.2  # Assuming 20% down payment
                loan_amount = max_property_value * 0.8
                emi = self.calculate_emi(loan_amount, 8.5, 20)
                required_income = emi / 0.4
                
                return f"""üí∞ **Affordability Analysis**

**üìä BASED ON YOUR DOWN PAYMENT:**
‚Ä¢ **Down Payment Available**: ‚Çπ{down_payment/100000:.1f} Lakhs
‚Ä¢ **Max Property Value**: ‚Çπ{max_property_value/100000:.1f} Lakhs
‚Ä¢ **Loan Required**: ‚Çπ{loan_amount/100000:.1f} Lakhs
‚Ä¢ **Monthly EMI**: ‚Çπ{emi:,.0f}
‚Ä¢ **Required Income**: ‚Çπ{required_income:,.0f}

**üè† PROPERTY OPTIONS:**
{self.get_affordable_areas(max_property_value/100000)}

**üí° FINANCIAL PLANNING:**
‚Ä¢ Ensure income supports ‚Çπ{emi:,.0f} EMI
‚Ä¢ Keep additional funds for registration/legal costs
‚Ä¢ Plan for monthly maintenance expenses
‚Ä¢ Consider property insurance costs

Ready to explore specific properties in your budget?"""
            
            else:
                return """üí∞ **Affordability Calculator**
                
I can help you determine what you can afford based on:

**Option 1: Income-Based**
Tell me your monthly income and I'll calculate:
‚Ä¢ Maximum EMI you can afford
‚Ä¢ Maximum loan amount
‚Ä¢ Property price range
‚Ä¢ Down payment required

**Option 2: Down Payment-Based**  
Tell me your available down payment and I'll show:
‚Ä¢ Maximum property value
‚Ä¢ Required monthly income
‚Ä¢ EMI obligations
‚Ä¢ Suitable areas

**Examples:**
‚Ä¢ "I earn ‚Çπ80,000 monthly, what can I afford?"
‚Ä¢ "I have ‚Çπ20 lakhs down payment, what property can I buy?"
‚Ä¢ "Affordability with ‚Çπ1 lakh monthly income"

**Quick Rules:**
‚Ä¢ EMI should be <40% of income
‚Ä¢ Down payment typically 20-25%
‚Ä¢ Keep 6-month EMI as emergency fund

What's your income or available down payment?"""
        
        except Exception as e:
            return "I can help with affordability analysis! Please share your monthly income or available down payment, and I'll show you what properties you can afford."
    
    def calculate_max_loan(self, max_emi, interest_rate=8.5, tenure=20):
        """Calculate maximum loan amount based on EMI capacity"""
        monthly_rate = interest_rate / (12 * 100)
        total_months = tenure * 12
        
        if monthly_rate > 0:
            max_loan = max_emi * ((1 + monthly_rate) ** total_months - 1) / \
                      (monthly_rate * (1 + monthly_rate) ** total_months)
        else:
            max_loan = max_emi * total_months
        
        return max_loan
    
    def calculate_emi(self, loan_amount, interest_rate, tenure):
        """Calculate EMI for given loan parameters"""
        monthly_rate = interest_rate / (12 * 100)
        total_months = tenure * 12
        
        if monthly_rate > 0:
            emi = (loan_amount * monthly_rate * (1 + monthly_rate) ** total_months) / \
                  ((1 + monthly_rate) ** total_months - 1)
        else:
            emi = loan_amount / total_months
        
        return emi
    
    def get_affordable_areas(self, max_budget):
        """Get areas within budget range"""
        if max_budget >= 100:
            return """**Premium Options (‚Çπ80L-120L+):**
‚Ä¢ Powai, Andheri, Bandra (outskirts)
‚Ä¢ Thane West (premium projects)
‚Ä¢ Goregaon East (commercial proximity)"""
        elif max_budget >= 60:
            return """**Mid-Range Options (‚Çπ40L-80L):**
‚Ä¢ Thane, Goregaon, Malad
‚Ä¢ Kandivali, Borivali
‚Ä¢ Powai (older projects)"""
        elif max_budget >= 40:
            return """**Value Options (‚Çπ25L-50L):**
‚Ä¢ Kalyan, Dombivli
‚Ä¢ Vasai, Virar
‚Ä¢ Thane (outskirts)"""
        else:
            return """**Budget Options (‚Çπ15L-35L):**
‚Ä¢ Kalyan East, Dombivli
‚Ä¢ Vasai East, Virar
‚Ä¢ Badlapur, Ambernath"""
    
    def get_contextual_response(self, message, entities):
        """Generate contextual response based on conversation history and user context"""
        
        # Check user context for personalized response
        if self.user_context.get('budget_range'):
            budget_context = self.user_context['budget_range']
            if budget_context == 'high':
                context_intro = "Given your premium budget range, "
            elif budget_context == 'medium':
                context_intro = "For your mid-range budget, "
            else:
                context_intro = "With your budget-conscious approach, "
        else:
            context_intro = ""
        
        # Generate contextual suggestions
        suggestions = []
        if entities['localities']:
            suggestions.append(f"Learn more about {entities['localities'][0].title()}")
        if entities['prices']:
            suggestions.append(f"Explore options for ‚Çπ{entities['prices'][0]} lakh budget")
        
        # Default contextual response
        return f"""{context_intro}I'm here to help with Mumbai real estate insights!

ü§î **I didn't quite understand that, but I can help with:**

**üè† Property Analysis:**
‚Ä¢ ROI calculations for any locality
‚Ä¢ Investment advice based on your budget
‚Ä¢ Market comparisons between areas
‚Ä¢ Risk assessment for investments

**üí∞ Financial Planning:**
‚Ä¢ EMI calculations and affordability
‚Ä¢ Down payment planning
‚Ä¢ Rental yield analysis
‚Ä¢ Portfolio diversification

**üìä Market Intelligence:**
‚Ä¢ Current trends and predictions
‚Ä¢ Area-specific insights
‚Ä¢ Infrastructure impact analysis
‚Ä¢ Growth potential assessment

**üí° Try asking:**
‚Ä¢ "ROI for ‚Çπ50L property in Thane"
‚Ä¢ "Compare Andheri vs Powai"
‚Ä¢ "Investment advice for ‚Çπ1 crore"
‚Ä¢ "Market trends in Mumbai"

{f"**Based on our conversation:** {', '.join(suggestions)}" if suggestions else ""}

What specific aspect of Mumbai real estate interests you most?"""

# Initialize chatbot service
def create_chatbot_service(ml_service):
    return PropTechChatbot(ml_service)
